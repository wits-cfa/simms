USAGE
=======

.. note::
   FITS-related examples, I have not fully tested yet.

Table of Contents
-------------------

- `Basic Simulation <#basic-simulation>`_
- `Common Use Cases <#common-use-cases>`_
- `Subtracting from or Adding to an Existing Column <#subtracting-from-or-adding-to-an-existing-column>`_
- `Advanced Use Cases <#advanced-use-cases>`_

SIMMS is a simulation framework built around two key tools: ``telsim`` and ``skysim``.

- **``telsim``**: Creates an empty Measurement Set (MS)
- **``skysim``**: Populates this MS by simulating visibilities, given a sky model. ``skysim`` also has an additional feature that lets you add or subtract from an existing data column

Basic Simulation
----------------

The simplest way to run a simulation::

   skysim --ms smallvis.ms --catalogue skymodel.txt --column SIMULATED_DATA

Let's break down what this command does:

- ``--ms smallvis.ms``: The MS where visibilities will be stored. You should already have the MS created (e.g., using ``telsim``)
- ``--catalogue skymodel.txt``: Your source catalogue containing the sky model
- ``--column SIMULATED_DATA``: The column where simulated visibilities will be written

Common Use Cases
----------------

1. When Catalogue is Given as Sky Model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your source catalogue is generated by PyBDSF::

   skysim --ms smallvis.ms --catalogue pybdsf.txt --cat-species bdsf_gaul --column SIMULATED_DATA

- ``--cat-species`` specifies the catalogue type. This automatically uses the correct mapping for a PyBDSF catalogue. You have to specify ``--cat-species`` if the catalogue is different from the default.

2. When FITS is Given as Sky Model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   skysim --ms smallvis.ms --fits-sky skymodel.fits --column SIMULATED_DATA

Subtracting from or Adding to an Existing Column
------------------------------------------------

You can subtract or add simulated data (or any data you already have) from/to an existing column in the MS.

**Steps:**

1. Simulate the data using the basic simulation command.

2. Add or Subtract to Existing Data

   You only need to specify the simulated column and the target column to add or subtract, assuming both already exist.

   **Adding:**

   ::

      skysim --ms smallvis.ms --sc SIMULATED_DATA --ic CORRECTED_DATA --column RESIDUALS --mode add

   **Subtracting:**

   ::

      skysim --ms smallvis.ms --sc SIMULATED_DATA --ic CORRECTED_DATA --column RESIDUALS --mode subtract

   Where:

   - ``--sc``: Simulated column (The name "SIMULATED_DATA" is an example assuming you will be using a column you just simulated, but it can be any column you choose to add or subtract)
   - ``--ic``: Input column you want to subtract/add from
   - ``--column``: In the add/subtract case, this is the column where your residuals will be saved
   - ``--mode``: Specifies whether to add/subtract or simulate (the default is simulate: skysim will just simulate if mode is not specified)

Advanced Use Cases
------------------

1. Simulating Polarized Sources
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For polarized sources, you can provide separate FITS files for each Stokes parameter::

   skysim --ms smallvis.ms --fits-sky stokes_i.fits stokes_q.fits stokes_u.fits stokes_v.fits --column SIMULATED_DATA --pol-basis linear

2. Adding Direction-Dependent and Independent Effects
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   skysim --ms smallvis.ms --fits-sky --catalogue skymodel.txt --column SIMULATED_DATA --die die.txt --dde dde.txt

3. Chunking for Large MS Data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   skysim --ms largevis.ms --catalogue skymodel.txt --column SIMULATED_DATA --rcs 5000

Where ``--rcs`` is the row chunk size. Default is 1000.

4. Adding Noise
~~~~~~~~~~~~~~~

::

   skysim --ms largevis.ms --catalogue skymodel.txt --column SIMULATED_DATA --sefd 421

5. FITS-Specific Cases
~~~~~~~~~~~~~~~~~~~~~~

::

   skysim --ms smallvis.ms --fits-sky model.fits --column SIMULATED_DATA --pixel-tol 1e-6 --fft-precision single --no-do-wstacking

Where:

- ``--pixel-tol``: Minimum brightness for a pixel to be considered in DFT. Default is 1e-7
- ``--fft-precision``: Precision for FFT calculations (single or double). Default is double
- ``--no-do-wstacking``: Disables w-stacking for FFT-based simulation. Default is enabled

Catalogue Types and Required Parameters
--------------------------------------

Supported Source Types
~~~~~~~~~~~~~~~~~~~~~

1. **Point Sources**

   - Requires: RA, DEC, Stokes I

2. **Extended Sources**

   - Requires: RA, DEC, Stokes I, emaj, emin, and pa

3. **Spectral Line Sources**

   - Requires: line_peak and line_width

4. **Continuum Sources**

   - Requires: cont_reffreq and cont_coef_1 (spectral index)
