.. _usage:

Usage 
=======

.. contents::
   :local:
   :depth: 2


Basic Simulation
----------------

The simplest way to run a simulation::

   simms skysim  --ascii-sky skymodel.txt --column DATA smallvis.ms

Let's break down what this command does:

- ``--ascii-sky skymodel.txt``: Your source catalogue containing the sky model
- ``--column SIMULATED_DATA``: The column where simulated visibilities will be written
- ``smallvis.ms``: The MS where visibilities will be stored. The MS must exist (e.g., from an observation or created by ``simms telsim``)

Common Use Cases
----------------

1. ASCII sky model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your sky model is a catalogue generated by PyBDSF::

   simms skysim --ascii-sky pybdsf.txt --cat-species bdsf_gaul --column DATA smallvis.ms

- ``--cat-species`` specifies the catalogue type. This automatically uses the correct mapping for a PyBDSF catalogue. You have to specify ``--cat-species`` if the catalogue is different from the default.

2. FITS sky model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   simms skysim --fits-sky skymodel.fits --column DATA smallvis.ms

Subtracting from or Adding to an Existing Column
------------------------------------------------

You can subtract or add simulated data (or any data you already have) from/to an existing column in the MS.

**Steps:**

1. Simulate the data using the basic simulation command.

2. Add or Subtract to Existing Data

   You only need to specify the simulated column and the target column to add or subtract, assuming both already exist.

   **Adding:**

   ::

      simm skysim --ic DATA --column MODEL_DATA --mode add smallvis.ms

   **Subtracting:**

   ::

      simm skysim --ic DATA --column MODEL_DATA --mode subtract smallvis.ms

   Where:

   - ``--ic``: Input column you want to subtract/add from
   - ``--column``: In the add/subtract case, this is the column where your residuals will be saved
   - ``--mode``: Specifies whether to add/subtract or simulate (the default is simulate: skysim will just simulate if mode is not specified)

Advanced Use Cases
------------------

1. Simulating Polarized Sources
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For polarized sources, you can provide separate FITS files for each Stokes parameter::

   simms skysim --fits-sky stokes_i.fits stokes_q.fits stokes_u.fits stokes_v.fits --column SIMULATED_DATA --pol-basis linear smallvis.ms


2. Chunking for Large MS Data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   simms skysim --ascii-sky skymodel.txt --column SIMULATED_DATA --rcs 5000 largevis.ms

Where ``--rcs`` is the row chunk size. Default is 1000.

1. Adding Noise
~~~~~~~~~~~~~~~

::

   simms skysim --ascii-sky skymodel.txt --column SIMULATED_DATA --sefd 421 largevis.ms

4. FITS-Specific Cases
~~~~~~~~~~~~~~~~~~~~~~

::

   simms skysim --fits-sky model.fits --column DATA --pixel-tol 1e-6 --fft-precision single --no-do-wstacking largevis.ms

Where:

- ``--pixel-tol``: Minimum brightness for a pixel to be considered in DFT. Default is 1e-7
- ``--fft-precision``: Precision for FFT calculations (single or double). Default is double
- ``--no-do-wstacking``: Disables w-stacking for FFT-based simulation. Default is enabled

5. Running using ``stimela``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can use ``stimela`` to execute both ``telsim`` and ``skysim`` as part of a pipeline. This allows you to create an MS and simulate the sky in a structured workflow.

Define the observation pipeline in a YAML file (e.g., `observe.yaml`) that includes the configuration for both ``telsim`` and ``skysim`` steps. Then, execute the pipeline with:

   stimela run observe.yaml

Refer to the `parser_config/observe.yaml` file for an example and the `Stimela documentation <https://github.com/caracal-pipeline/stimela>`_ for more details on how to define and run a pipeline in ``stimela``.

Catalogue Types and Required Parameters
----------------------------------------

Supported Source Types
~~~~~~~~~~~~~~~~~~~~~~~

1. **Point Sources**

   - Requires: RA, DEC, Stokes I

2. **Extended Sources**

   - Requires: RA, DEC, Stokes I, emaj, emin and pa

3. **Spectral Line Sources**

   - Requires: ``line_peak`` and ``line_width``

4. **Continuum Sources**

   - Requires: ``cont_reffreq`` and ``cont_coef_1`` (spectral index)
