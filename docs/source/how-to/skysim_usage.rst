SkySim Usage
========================


Basic Simulation
----------------

The simplest way to run a simulation::

   simms skysim  --ascii-sky skymodel.txt --column DATA smallvis.ms

Let's break down what this command does:

- ``--ascii-sky skymodel.txt``: Your source catalogue containing the sky model
- ``--column SIMULATED_DATA``: The column where simulated visibilities will be written
- ``smallvis.ms``: The MS where visibilities will be stored. The MS must exist (e.g., from an observation or created by ``simms telsim``)

Common Use Cases
----------------

1. ASCII sky model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your sky model is a catalogue generated by PyBDSF::

   simms skysim --ascii-sky pybdsf.txt --cat-species bdsf_gaul --column DATA smallvis.ms

- ``--cat-species`` specifies the catalogue type. This automatically uses the correct mapping for a PyBDSF catalogue. You have to specify ``--cat-species`` if the catalogue is different from the default.

2. FITS sky model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

   simms skysim --fits-sky skymodel.fits --column DATA smallvis.ms

Subtracting from or Adding to an Existing Column
------------------------------------------------

You can subtract or add simulated data (or any data you already have) from/to an existing column in the MS.

**Steps:**

1. Simulate the data using the basic simulation command.

2. Add or Subtract to Existing Data

   You only need to specify the simulated column and the target column to add or subtract, assuming both already exist.

   **Adding:**

   ::

      simm skysim --ic DATA --column MODEL_DATA --mode add smallvis.ms

   **Subtracting:**

   ::

      simm skysim --ic DATA --column MODEL_DATA --mode subtract smallvis.ms

   Where:

   - ``--ic``: Input column you want to subtract/add from
   - ``--column``: In the add/subtract case, this is the column where your residuals will be saved
   - ``--mode``: Specifies whether to add/subtract or simulate (the default is simulate: skysim will just simulate if mode is not specified)

Advanced Use Cases
------------------

1. Simulating Polarized Sources
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For polarized sources, you can provide separate FITS files for each Stokes parameter::

   simms skysim --fits-sky stokes_i.fits stokes_q.fits stokes_u.fits stokes_v.fits --column SIMULATED_DATA --pol-basis linear smallvis.ms


2. Chunking for Large MS Data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   simms skysim --ascii-sky skymodel.txt --column SIMULATED_DATA --rcs 5000 largevis.ms

where ``--rcs`` is the row chunk size. Default is 1000.

3. Adding Noise
~~~~~~~~~~~~~~~

.. code-block:: bash

   simms skysim --ascii-sky skymodel.txt --column SIMULATED_DATA --sefd 421 largevis.ms

4. FITS-Specific Cases
~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   simms skysim --fits-sky model.fits --column DATA --pixel-tol 1e-6 --fft-precision single --no-do-wstacking largevis.ms

where:

- ``--pixel-tol``: Minimum brightness for a pixel to be considered in DFT. Default is 1e-7
- ``--fft-precision``: Precision for FFT calculations (single or double). Default is double
- ``--no-do-wstacking``: Disables w-stacking for FFT-based simulation. Default is enabled

.. 
   5. End-to-End Simulation
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ASCII Sky Model Basics
----------------------------

1. **Point Sources**

   - The simplest source that can be simulated is a point source, which only requires the RA, Dec, and intensity (``stokes_i``)

2. **Extended Sources**

   - The only resolved sources supported are 2D Gaussian sources. These sources are parametrised via the FHWM values for the major and minor axes (``emaj`` and ``emin``) and the position angle (``pa``). 

3. **Spectral Line Sources**
   - For spectral line sources, the frequency where the line peaks (``line_peak``) needs to be specified along with the width of the line (``line_width``). Double-horn profiles are not supported at this point.

4. **Continuum Sources**

   - Continuum sources require the reference frequency (``cont_reffreq``) and at least one (of three) power-law coefficient (``cont_coeff_<number>``). Where, ``cont_coeff_1`` is the spectral index, ``cont_coeff_2`` is the spectral curvature, and so on.
